<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Herramienta IA Interna</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f6f8;
}
header {
  background: #1b396a;
  color: #fff;
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
main {
  padding: 20px;
}
button {
  padding: 10px 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 8px;
}
.btn-primary {
  background: #1b396a;
  color: white;
}
.btn-secondary {
  background: #777;
  color: white;
}
#usageCounter {
  font-size: 0.75rem;
  background: rgba(0,0,0,0.4);
  padding: 4px 8px;
  border-radius: 4px;
}
#canvasContainer {
  margin-top: 20px;
  background: white;
  border: 1px solid #ccc;
  display: inline-block;
}
canvas {
  display: block;
}
#loader {
  display: none;
  margin-top: 10px;
}
#loader.active {
  display: block;
}
</style>
</head>

<body>

<header>
  <strong>Herramienta IA Interna</strong>
  <span id="usageCounter"></span>
</header>

<main>

  <div>
    <button class="btn-primary" onclick="quickUseAI()">âš¡ Uso rÃ¡pido institucional</button>
    <button class="btn-secondary" onclick="generateBackground()">ðŸŽ¨ Generar fondo</button>
  </div>

  <div id="loader">Procesando IAâ€¦</div>

  <div id="canvasContainer">
    <canvas id="canvas" width="1000" height="600"></canvas>
  </div>

</main>

<script type="module">
/* ===============================
   CONFIGURACIÃ“N IA
================================ */

import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

let ai = null;

function initAI() {
  const key = localStorage.getItem("GOOGLE_API_KEY");
  if (!key) {
    const k = prompt("Ingresa API Key de Google Gemini:");
    if (!k) return;
    localStorage.setItem("GOOGLE_API_KEY", k);
    location.reload();
    return;
  }
  ai = new GoogleGenerativeAI(key);
}

/* ===============================
   CONTADOR TRIMESTRAL
================================ */

function getCurrentQuarter() {
  const m = new Date().getMonth() + 1;
  if (m <= 3) return 1;
  if (m <= 6) return 2;
  if (m <= 9) return 3;
  return 4;
}

function initUsageCounter() {
  const now = new Date();
  const year = now.getFullYear();
  const quarter = getCurrentQuarter();
  const currentKey = `${year}-Q${quarter}`;

  const savedKey = localStorage.getItem("ITD_USAGE_PERIOD");
  if (savedKey !== currentKey) {
    localStorage.setItem("ITD_USAGE_PERIOD", currentKey);
    localStorage.setItem("ITD_USAGE_COUNT", "0");
  }
}

function incrementUsage() {
  let count = parseInt(localStorage.getItem("ITD_USAGE_COUNT") || "0", 10);
  count++;
  localStorage.setItem("ITD_USAGE_COUNT", count.toString());
  updateUsageUI();
}

function updateUsageUI() {
  const count = localStorage.getItem("ITD_USAGE_COUNT") || "0";
  const period = localStorage.getItem("ITD_USAGE_PERIOD") || "";
  document.getElementById("usageCounter").innerText =
    `Uso IA: ${count} (${period})`;
}

/* ===============================
   CANVAS
================================ */

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let layers = [];

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  layers.forEach(l => {
    if (l.type === "image") {
      ctx.drawImage(l.img, 0, 0, canvas.width, canvas.height);
    }
    if (l.type === "text") {
      ctx.fillStyle = l.color;
      ctx.font = `${l.size}px Arial`;
      ctx.fillText(l.text, l.x, l.y);
    }
  });
}

/* ===============================
   IA FUNCIONES
================================ */

window.generateBackground = async function () {
  if (!ai) return alert("IA no configurada");

  incrementUsage();
  document.getElementById("loader").classList.add("active");

  const prompt = `
  Fondo institucional moderno,
  colores azul marino y dorado,
  estilo tecnolÃ³gico limpio,
  sin texto.
  `;

  try {
    const res = await ai.models.generateContent({
      model: "gemini-2.5-flash-image",
      contents: { parts: [{ text: prompt }] }
    });

    let img64 = null;
    for (const p of res.candidates[0].content.parts) {
      if (p.inlineData) { img64 = p.inlineData.data; break; }
    }

    const img = new Image();
    img.onload = () => {
      layers = [{ type: "image", img }];
      render();
      document.getElementById("loader").classList.remove("active");
    };
    img.src = "data:image/png;base64," + img64;

  } catch {
    alert("Error al generar fondo");
    document.getElementById("loader").classList.remove("active");
  }
};

window.quickUseAI = async function () {
  if (!ai) return alert("IA no configurada");

  incrementUsage();
  document.getElementById("loader").classList.add("active");

  const prompt = `
  Fondo institucional acadÃ©mico,
  moderno, profesional,
  tonos azul marino y dorado,
  sin texto.
  `;

  try {
    const res = await ai.models.generateContent({
      model: "gemini-2.5-flash-image",
      contents: { parts: [{ text: prompt }] }
    });

    let img64 = null;
    for (const p of res.candidates[0].content.parts) {
      if (p.inlineData) { img64 = p.inlineData.data; break; }
    }

    const img = new Image();
    img.onload = () => {
      layers = [
        { type: "image", img },
        {
          type: "text",
          text: "TÃ­tulo institucional",
          x: 100,
          y: 120,
          size: 48,
          color: "#1b396a"
        }
      ];
      render();
      document.getElementById("loader").classList.remove("active");
    };
    img.src = "data:image/png;base64," + img64;

  } catch {
    alert("Error en uso rÃ¡pido");
    document.getElementById("loader").classList.remove("active");
  }
};

/* ===============================
   INIT
================================ */

initAI();
initUsageCounter();
updateUsageUI();
render();

</script>

</body>
</html>
