<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio de Diseño AI - ITD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Import Map para Google GenAI -->
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.run/@google/genai"
        }
      }
    </script>
    <style>
        :root {
            --primary: #1b396a;
            --accent: #d4a017;
            --maroon: #8B1538;
            --bg-dark: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-light: #f5f5f5;
            --border: #444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        .header {
            height: 50px;
            background: var(--primary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            border-bottom: 1px solid #000;
        }
        
        .header h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .back-link { color: white; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .back-link:hover { color: var(--accent); }

        /* MAIN LAYOUT */
        .workspace {
            display: flex;
            flex: 1;
            height: calc(100vh - 50px);
        }

        /* TOOLBAR (LEFT) */
        .toolbar {
            width: 60px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            gap: 15px;
            z-index: 10;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tool-btn.active { background: var(--accent); color: var(--primary); }
        .tool-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50px;
            background: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 20;
        }

        /* CANVAS AREA (CENTER) */
        .canvas-area {
            flex: 1;
            background: #111;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        canvas {
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: default;
        }

        /* PROPERTIES & LAYERS (RIGHT) */
        .sidebar {
            width: 300px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        /* CONTROLS */
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #ccc; }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            background: #222;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        input[type="color"] {
            width: 100%;
            height: 35px;
            border: none;
            background: none;
            cursor: pointer;
        }

        .btn-action {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-action:hover { filter: brightness(1.2); }
        .btn-action.secondary { background: #444; }
        .btn-action.ai { background: linear-gradient(135deg, var(--maroon), var(--primary)); }

        /* LAYER LIST */
        .layer-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #333;
            margin-bottom: 2px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .layer-item.selected {
            background: #444;
            border-left-color: var(--accent);
        }

        .layer-item i { margin-right: 10px; width: 15px; text-align: center; }
        .layer-name { flex: 1; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .layer-actions i { cursor: pointer; color: #666; font-size: 0.8rem; margin-left: 5px; }
        .layer-actions i:hover { color: #fff; }

        /* LOADING */
        .loader {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .loader.active { display: flex; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODAL */
        .modal {
            display: none;
            position: fixed; z-index: 200;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            border: 1px solid var(--border);
        }
        
        .api-key-banner {
            background: #333; 
            padding: 10px; 
            font-size: 0.8rem; 
            text-align: center; 
            border-bottom: 1px solid #444;
        }

        /* RESIZE HANDLES */
        .resize-handle {
            position: absolute;
            width: 10px; height: 10px;
            background: white;
            border: 1px solid var(--primary);
            border-radius: 50%;
            pointer-events: none; /* Handle via logic */
        }
    </style>
</head>
<body>

    <div class="header">
        <h1><i class="fas fa-layer-group"></i> Estudio de Diseño AI <span style="font-size: 0.7rem; background: var(--accent); color: black; padding: 2px 6px; border-radius: 4px;">BETA</span></h1>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Portal</a>
    </div>

    <!-- API KEY Warning (Simulated for this environment) -->
    <div class="api-key-banner" id="apiKeyBanner">
        Nota: Las funciones IA requieren configurar tu API Key de Google Gemini.
        <button onclick="showApiKeyModal()" style="background:none; border:none; color: var(--accent); text-decoration: underline; cursor:pointer;">Configurar</button>
    </div>

    <div class="workspace">
        <!-- TOOLBAR -->
        <div class="toolbar">
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()" data-tooltip="Subir Imagen"><i class="fas fa-upload"></i></button>
            <button class="tool-btn" onclick="addTextLayer()" data-tooltip="Añadir Texto"><i class="fas fa-font"></i></button>
            <button class="tool-btn" onclick="addShape('rect')" data-tooltip="Rectángulo"><i class="fas fa-vector-square"></i></button>
            <button class="tool-btn" onclick="addShape('circle')" data-tooltip="Círculo"><i class="fas fa-circle"></i></button>
            <div style="width: 30px; height: 1px; background: #555; margin: 5px 0;"></div>
            <button class="tool-btn active" id="toolSelect" onclick="setTool('select')" data-tooltip="Mover/Seleccionar"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="toolEraser" onclick="removeBackgroundOfSelected()" data-tooltip="IA: Quitar Fondo"><i class="fas fa-eraser" style="color: var(--accent);"></i></button>
        </div>

        <!-- CANVAS -->
        <div class="canvas-area" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p id="loaderText" style="margin-top: 15px;">Procesando con IA...</p>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- PROPIEDADES -->
            <div class="panel-section">
                <div class="panel-title">Propiedades</div>
                <div id="propertiesPanel">
                    <p style="color: #666; font-size: 0.8rem; text-align: center;">Selecciona un elemento</p>
                </div>
            </div>

            <!-- CAPAS -->
            <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-title">
                    Capas
                    <div>
                        <i class="fas fa-arrow-up" style="cursor: pointer; margin-right: 5px;" onclick="moveLayer(-1)" title="Subir"></i>
                        <i class="fas fa-arrow-down" style="cursor: pointer;" onclick="moveLayer(1)" title="Bajar"></i>
                    </div>
                </div>
                <div class="layer-list" id="layerList">
                    <!-- Layer items injected here -->
                </div>
            </div>

            <!-- IA TOOLS -->
            <div class="panel-section">
                <div class="panel-title"><i class="fas fa-sparkles" style="color: var(--accent);"></i> Generador IA</div>
                <div class="control-group">
                    <textarea id="aiPrompt" placeholder="Ej: Un paisaje futurista de neón..." rows="2" style="margin-bottom: 5px;"></textarea>
                    <button class="btn-action ai" onclick="generateBackgroundAI()">Generar Fondo</button>
                </div>
                <button class="btn-action secondary" onclick="suggestCaptionAI()"><i class="fas fa-lightbulb"></i> Sugerir Frase</button>
            </div>

            <!-- EXPORT -->
            <div class="panel-section">
                <button class="btn-action" onclick="downloadDesign()"><i class="fas fa-download"></i> Descargar Diseño</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

    <!-- API KEY MODAL -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Configurar Gemini API</h3>
            <p style="font-size: 0.9rem; margin-bottom: 15px; color: #ccc;">Ingresa tu API Key para usar las funciones de generación de imágenes y texto.</p>
            <input type="password" id="userApiKey" placeholder="Pegar API Key aquí...">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-action secondary" onclick="document.getElementById('apiKeyModal').classList.remove('show')">Cancelar</button>
                <button class="btn-action" onclick="saveApiKey()">Guardar</button>
            </div>
            <p style="font-size: 0.75rem; margin-top: 10px; color: #666;">La clave se guarda solo en tu navegador.</p>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // ENGINE STATE
        // ==========================================
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');
        
        // Initial Canvas Size
        canvas.width = 800;
        canvas.height = 600;

        let layers = []; // { id, type, x, y, width, height, content, color, font, rotation, visible }
        let selectedLayerId = null;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let apiKey = localStorage.getItem('GEMINI_API_KEY') || '';

        // ==========================================
        // CORE RENDER LOOP
        // ==========================================
        function render() {
            // 1. Clear Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff'; // Default white canvas background if no bg layer
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Draw Layers
            layers.forEach(layer => {
                if (!layer.visible) return;
                
                ctx.save();
                
                // Position & Rotation
                const cx = layer.x + layer.width / 2;
                const cy = layer.y + layer.height / 2;
                ctx.translate(cx, cy);
                ctx.rotate(layer.rotation * Math.PI / 180);
                ctx.translate(-cx, -cy);

                if (layer.type === 'image') {
                    if (layer.imgElement) {
                        ctx.drawImage(layer.imgElement, layer.x, layer.y, layer.width, layer.height);
                    }
                } else if (layer.type === 'shape') {
                    ctx.fillStyle = layer.color;
                    if (layer.shapeType === 'rect') {
                        ctx.fillRect(layer.x, layer.y, layer.width, layer.height);
                    } else if (layer.shapeType === 'circle') {
                        ctx.beginPath();
                        ctx.ellipse(cx, cy, layer.width/2, layer.height/2, 0, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                } else if (layer.type === 'text') {
                    ctx.font = `${layer.fontSize}px ${layer.fontFamily}`;
                    ctx.fillStyle = layer.color;
                    ctx.textBaseline = 'top';
                    ctx.fillText(layer.content, layer.x, layer.y);
                    // Approximate width/height for selection hit test
                    const metrics = ctx.measureText(layer.content);
                    layer.width = metrics.width;
                    layer.height = layer.fontSize; // Rough approximation
                }

                // Selection Box
                if (layer.id === selectedLayerId) {
                    ctx.strokeStyle = '#d4a017';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(layer.x - 2, layer.y - 2, layer.width + 4, layer.height + 4);
                    
                    // Resize Handle (Bottom Right)
                    ctx.fillStyle = '#d4a017';
                    ctx.fillRect(layer.x + layer.width - 5, layer.y + layer.height - 5, 10, 10);
                }

                ctx.restore();
            });
        }

        // ==========================================
        // LAYER MANAGEMENT
        // ==========================================
        function createId() { return Math.random().toString(36).substr(2, 9); }

        window.addLayer = (layerData) => {
            const newLayer = {
                id: createId(),
                x: 50, y: 50,
                width: 100, height: 100,
                rotation: 0,
                visible: true,
                ...layerData
            };
            layers.push(newLayer);
            selectedLayerId = newLayer.id;
            updateUI();
            render();
        };

        window.addTextLayer = (content = 'Texto Nuevo') => {
            window.addLayer({
                type: 'text',
                content: content,
                fontSize: 40,
                fontFamily: 'Arial',
                color: '#000000',
                width: 100, height: 40
            });
        };

        window.addShape = (shapeType) => {
            window.addLayer({
                type: 'shape',
                shapeType: shapeType,
                color: '#1b396a',
                width: 150, height: 150
            });
        };

        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Fit to canvas if too big
                        let w = img.width;
                        let h = img.height;
                        if (w > 600) {
                            const ratio = 600 / w;
                            w = 600; h = h * ratio;
                        }
                        
                        window.addLayer({
                            type: 'image',
                            imgElement: img,
                            width: w,
                            height: h,
                            x: (canvas.width - w) / 2,
                            y: (canvas.height - h) / 2,
                            originalData: img.src // Store for AI processing
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.removeLayer = (id) => {
            layers = layers.filter(l => l.id !== id);
            if (selectedLayerId === id) selectedLayerId = null;
            updateUI();
            render();
        };

        window.moveLayer = (dir) => {
            if (!selectedLayerId) return;
            const idx = layers.findIndex(l => l.id === selectedLayerId);
            if (idx === -1) return;
            
            const newIdx = idx + dir;
            if (newIdx >= 0 && newIdx < layers.length) {
                [layers[idx], layers[newIdx]] = [layers[newIdx], layers[idx]];
                updateUI();
                render();
            }
        };

        window.selectLayer = (id) => {
            selectedLayerId = id;
            updateUI();
            render();
        };

        // ==========================================
        // UI UPDATES
        // ==========================================
        function updateUI() {
            // Update Layer List
            const list = document.getElementById('layerList');
            list.innerHTML = '';
            // Render in reverse order (top layer first in list)
            [...layers].reverse().forEach(layer => {
                const div = document.createElement('div');
                div.className = `layer-item ${layer.id === selectedLayerId ? 'selected' : ''}`;
                div.onclick = () => window.selectLayer(layer.id);
                
                let icon = 'fa-layer-group';
                let name = 'Capa';
                if (layer.type === 'text') { icon = 'fa-font'; name = layer.content; }
                if (layer.type === 'image') { icon = 'fa-image'; name = 'Imagen'; }
                if (layer.type === 'shape') { icon = 'fa-shapes'; name = 'Forma'; }

                div.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span class="layer-name">${name}</span>
                    <div class="layer-actions">
                        <i class="fas fa-eye${layer.visible ? '' : '-slash'}" onclick="event.stopPropagation(); toggleVis('${layer.id}')"></i>
                        <i class="fas fa-trash" onclick="event.stopPropagation(); removeLayer('${layer.id}')"></i>
                    </div>
                `;
                list.appendChild(div);
            });

            // Update Properties Panel
            const propsPanel = document.getElementById('propertiesPanel');
            const selLayer = layers.find(l => l.id === selectedLayerId);
            
            if (!selLayer) {
                propsPanel.innerHTML = '<p style="color: #666; font-size: 0.8rem; text-align: center;">Selecciona un elemento</p>';
                return;
            }

            let html = '';
            
            // Common Props
            html += `
                <div class="control-group">
                    <label>Opacidad</label>
                    <input type="range" min="0" max="1" step="0.1" value="${selLayer.opacity || 1}" oninput="updateProp('opacity', this.value)">
                </div>
            `;

            if (selLayer.type === 'text') {
                html += `
                    <div class="control-group"><label>Texto</label><input type="text" value="${selLayer.content}" oninput="updateProp('content', this.value)"></div>
                    <div class="control-group"><label>Tamaño</label><input type="number" value="${selLayer.fontSize}" oninput="updateProp('fontSize', this.value)"></div>
                    <div class="control-group"><label>Color</label><input type="color" value="${selLayer.color}" oninput="updateProp('color', this.value)"></div>
                    <div class="control-group"><label>Fuente</label>
                        <select onchange="updateProp('fontFamily', this.value)">
                            <option value="Arial" ${selLayer.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                            <option value="Georgia" ${selLayer.fontFamily === 'Georgia' ? 'selected' : ''}>Georgia</option>
                            <option value="Courier New" ${selLayer.fontFamily === 'Courier New' ? 'selected' : ''}>Courier</option>
                            <option value="Verdana" ${selLayer.fontFamily === 'Verdana' ? 'selected' : ''}>Verdana</option>
                        </select>
                    </div>
                `;
            } else if (selLayer.type === 'shape') {
                html += `
                    <div class="control-group"><label>Color</label><input type="color" value="${selLayer.color}" oninput="updateProp('color', this.value)"></div>
                    <div class="control-group"><label>Ancho</label><input type="number" value="${selLayer.width}" oninput="updateProp('width', this.value)"></div>
                    <div class="control-group"><label>Alto</label><input type="number" value="${selLayer.height}" oninput="updateProp('height', this.value)"></div>
                `;
            } else if (selLayer.type === 'image') {
                 html += `
                    <div class="control-group"><label>Ancho</label><input type="number" value="${parseInt(selLayer.width)}" oninput="updateProp('width', this.value)"></div>
                    <div class="control-group"><label>Alto</label><input type="number" value="${parseInt(selLayer.height)}" oninput="updateProp('height', this.value)"></div>
                `;
            }

            propsPanel.innerHTML = html;
        }

        window.updateProp = (key, value) => {
            const layer = layers.find(l => l.id === selectedLayerId);
            if (layer) {
                if (key === 'width' || key === 'height' || key === 'fontSize') value = parseInt(value);
                layer[key] = value;
                render();
            }
        };

        window.toggleVis = (id) => {
            const layer = layers.find(l => l.id === id);
            if (layer) {
                layer.visible = !layer.visible;
                updateUI();
                render();
            }
        };

        // ==========================================
        // MOUSE EVENTS (Interaction)
        // ==========================================
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Check hit test (reverse to check top layers first)
            let hit = false;
            for (let i = layers.length - 1; i >= 0; i--) {
                const l = layers[i];
                if (!l.visible) continue;
                if (mouseX >= l.x && mouseX <= l.x + l.width && mouseY >= l.y && mouseY <= l.y + l.height) {
                    selectedLayerId = l.id;
                    isDragging = true;
                    dragStart = { x: mouseX - l.x, y: mouseY - l.y };
                    hit = true;
                    updateUI();
                    render();
                    break;
                }
            }
            if (!hit) {
                selectedLayerId = null;
                updateUI();
                render();
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging && selectedLayerId) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const layer = layers.find(l => l.id === selectedLayerId);
                if (layer) {
                    layer.x = mouseX - dragStart.x;
                    layer.y = mouseY - dragStart.y;
                    render();
                }
            }
        });

        window.addEventListener('mouseup', () => { isDragging = false; });

        // ==========================================
        // AI FEATURES (Gemini)
        // ==========================================
        window.showApiKeyModal = () => document.getElementById('apiKeyModal').classList.add('show');
        
        window.saveApiKey = () => {
            apiKey = document.getElementById('userApiKey').value;
            localStorage.setItem('GEMINI_API_KEY', apiKey);
            document.getElementById('apiKeyModal').classList.remove('show');
            alert('API Key guardada.');
        };

        function getAIClient() {
            if (!apiKey) {
                showApiKeyModal();
                return null;
            }
            return new GoogleGenAI({ apiKey: apiKey });
        }

        // 1. Remove Background (Pixel Algorithm from previous version, wrapped)
        window.removeBackgroundOfSelected = () => {
            const layer = layers.find(l => l.id === selectedLayerId);
            if (!layer || layer.type !== 'image' || !layer.imgElement) {
                alert('Selecciona una capa de imagen primero.');
                return;
            }

            document.getElementById('loader').classList.add('active');
            document.getElementById('loaderText').innerText = 'Eliminando fondo (Algoritmo local)...';

            setTimeout(() => {
                // Draw image to temp canvas
                const tempC = document.createElement('canvas');
                tempC.width = layer.width;
                tempC.height = layer.height;
                const tempCtx = tempC.getContext('2d');
                tempCtx.drawImage(layer.imgElement, 0, 0, layer.width, layer.height);
                
                const imageData = tempCtx.getImageData(0, 0, layer.width, layer.height);
                const data = imageData.data;
                
                // Sample corners for background color
                const samples = [];
                const corners = [0, layer.width-1, layer.width*(layer.height-1), layer.width*layer.height-1];
                corners.forEach(idx => {
                    const i = idx * 4;
                    samples.push({ r: data[i], g: data[i+1], b: data[i+2] });
                });
                
                const bg = samples.reduce((acc, c) => ({ r: acc.r + c.r, g: acc.g + c.g, b: acc.b + c.b }), {r:0, g:0, b:0});
                bg.r /= samples.length; bg.g /= samples.length; bg.b /= samples.length;

                const tolerance = 40;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    const diff = Math.sqrt(Math.pow(r - bg.r, 2) + Math.pow(g - bg.g, 2) + Math.pow(b - bg.b, 2));
                    if (diff < tolerance) data[i+3] = 0;
                }
                
                tempCtx.putImageData(imageData, 0, 0);
                
                // Replace image source
                const newImg = new Image();
                newImg.onload = () => {
                    layer.imgElement = newImg;
                    document.getElementById('loader').classList.remove('active');
                    render();
                };
                newImg.src = tempC.toDataURL();
            }, 100);
        };

        // 2. Generate Background (Gemini/Imagen)
        window.generateBackgroundAI = async () => {
            const ai = getAIClient();
            if (!ai) return;

            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) { alert('Escribe una descripción para el fondo.'); return; }

            const loader = document.getElementById('loader');
            loader.classList.add('active');
            document.getElementById('loaderText').innerText = 'Generando Fondo con IA...';

            try {
                // Use generateContent with gemini-2.5-flash-image for generation (Simulating Imagen behavior via instructions)
                // Instructions say: "General Image Generation...: 'gemini-2.5-flash-image'"
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: {
                        parts: [{ text: prompt }]
                    },
                    config: {
                        imageConfig: { aspectRatio: "4:3" }
                    }
                });

                // Extract image
                let base64Image = null;
                if(response.candidates?.[0]?.content?.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData) {
                            base64Image = part.inlineData.data;
                            break;
                        }
                    }
                }

                if (base64Image) {
                    const img = new Image();
                    img.onload = () => {
                        // Add as bottom layer
                        const newLayer = {
                            id: createId(),
                            type: 'image',
                            imgElement: img,
                            x: 0, y: 0,
                            width: canvas.width,
                            height: canvas.height,
                            visible: true,
                            rotation: 0
                        };
                        layers.unshift(newLayer); // Add to beginning (bottom)
                        updateUI();
                        render();
                        loader.classList.remove('active');
                    };
                    img.src = `data:image/png;base64,${base64Image}`;
                } else {
                    throw new Error('No image returned');
                }

            } catch (error) {
                console.error(error);
                alert('Error generando imagen: ' + error.message);
                loader.classList.remove('active');
            }
        };

        // 3. Suggest Caption (Gemini Text)
        window.suggestCaptionAI = async () => {
            const ai = getAIClient();
            if (!ai) return;

            const loader = document.getElementById('loader');
            loader.classList.add('active');
            document.getElementById('loaderText').innerText = 'Analizando diseño...';

            try {
                // Get current canvas state as base64
                const currentDesign = canvas.toDataURL('image/jpeg').split(',')[1];

                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: {
                        parts: [
                            { inlineData: { mimeType: 'image/jpeg', data: currentDesign } },
                            { text: "Suggest a short, catchy, professional title (max 5 words) for this design in Spanish. Just the text." }
                        ]
                    }
                });

                const text = response.text.trim().replace(/"/g, '');
                window.addTextLayer(text);
                loader.classList.remove('active');

            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
                loader.classList.remove('active');
            }
        };

        window.downloadDesign = () => {
            const link = document.createElement('a');
            link.download = 'diseño_itd.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        // Init
        render();

    </script>
</body>
</html>
