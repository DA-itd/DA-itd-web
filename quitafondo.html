<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Herramienta IA â€“ Uso Interno</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#eef1f4;}
header{background:#1b396a;color:#fff;padding:10px 16px;display:flex;justify-content:space-between;}
main{display:flex;gap:12px;padding:12px;}
aside{width:300px;background:#fff;padding:12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);}
section{flex:1;background:#fff;padding:12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);}
button{width:100%;padding:8px;margin-bottom:6px;border:none;border-radius:4px;cursor:pointer;}
.btn-ai{background:#1b396a;color:#fff;}
.btn-sec{background:#777;color:#fff;}
.btn-warn{background:#b33;color:#fff;}
input,textarea{width:100%;margin-bottom:6px;padding:6px;}
canvas{border:2px dashed #ccc;}
#canvas.dragover{border-color:#1b396a;}
#loader{display:none;color:#1b396a;font-weight:bold;}
#loader.active{display:block;}
small{opacity:.7;}
</style>
</head>

<body>

<header>
  <strong>Herramienta IA Interna</strong>
  <small>Arrastra una imagen al lienzo</small>
</header>

<main>

<aside>
  <button class="btn-sec" onclick="openFile()">ðŸ“‚ Cargar imagen</button>
  <input type="file" id="fileInput" accept="image/*" hidden>

  <button class="btn-ai" onclick="quickUse()">âš¡ Uso rÃ¡pido institucional</button>
  <button class="btn-ai" onclick="generateBackground()">ðŸŽ¨ Generar fondo IA</button>
  <button class="btn-ai" onclick="removeBackground()">âœ‚ Quitar fondo</button>

  <hr>
  <button class="btn-sec" onclick="saveTemplate()">ðŸ’¾ Guardar plantilla</button>
  <button class="btn-sec" onclick="loadTemplate()">ðŸ“‚ Cargar plantilla</button>
  <button class="btn-warn" onclick="clearCanvas()">ðŸ—‘ Limpiar todo</button>

  <div id="loader">Procesandoâ€¦</div>
</aside>

<section>
  <canvas id="canvas" width="1000" height="600"></canvas>

  <hr>
  <strong>Texto</strong>
  <input id="txtContent" placeholder="Texto institucional">
  <input id="txtSize" type="number" value="48">
  <input id="txtColor" type="color" value="#1b396a">
  <button class="btn-sec" onclick="addText()">âž• Agregar texto</button>
</section>

</main>

<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
let ai=null;

function initAI(){
  const k=localStorage.getItem("GOOGLE_API_KEY");
  if(!k){
    const p=prompt("Ingresa API Key de Google Gemini:");
    if(!p)return;
    localStorage.setItem("GOOGLE_API_KEY",p);
    location.reload();return;
  }
  ai=new GoogleGenerativeAI(k);
}

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let layers=[];

/* -------- Drag & Drop -------- */
canvas.addEventListener("dragover",e=>{
  e.preventDefault();canvas.classList.add("dragover");
});
canvas.addEventListener("dragleave",()=>canvas.classList.remove("dragover"));
canvas.addEventListener("drop",e=>{
  e.preventDefault();canvas.classList.remove("dragover");
  loadFile(e.dataTransfer.files[0]);
});

/* -------- File load -------- */
window.openFile=()=>fileInput.click();
fileInput.onchange=e=>loadFile(e.target.files[0]);

function loadFile(file){
  if(!file||!file.type.startsWith("image/"))return;
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();
    img.onload=()=>{
      layers.unshift({type:"image",img});
      render();
    };
    img.src=reader.result;
  };
  reader.readAsDataURL(file);
}

/* -------- Canvas -------- */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  layers.forEach(l=>{
    if(l.type==="image")ctx.drawImage(l.img,0,0,canvas.width,canvas.height);
    if(l.type==="text"){
      ctx.fillStyle=l.color;
      ctx.font=`${l.size}px Arial`;
      ctx.fillText(l.text,l.x,l.y);
    }
  });
}

/* -------- IA -------- */
async function generateImage(prompt){
  document.getElementById("loader").classList.add("active");
  const res=await ai.models.generateContent({
    model:"gemini-2.5-flash-image",
    contents:{parts:[{text:prompt}]}
  });
  document.getElementById("loader").classList.remove("active");
  for(const p of res.candidates[0].content.parts){
    if(p.inlineData)return p.inlineData.data;
  }
  return null;
}

window.generateBackground=async()=>{
  if(!ai)return alert("IA no configurada");
  const img64=await generateImage(
    "Fondo institucional moderno, azul marino y dorado, sin texto"
  );
  if(!img64)return;
  const img=new Image();
  img.onload=()=>{layers.unshift({type:"image",img});render();};
  img.src="data:image/png;base64,"+img64;
};

window.quickUse=async()=>{
  if(!ai)return alert("IA no configurada");
  const img64=await generateImage(
    "Banner institucional acadÃ©mico, profesional, azul marino y dorado, sin texto"
  );
  if(!img64)return;
  const img=new Image();
  img.onload=()=>{
    layers=[
      {type:"image",img},
      {type:"text",text:"TÃ­tulo institucional",x:100,y:120,size:48,color:"#1b396a"}
    ];
    render();
  };
  img.src="data:image/png;base64,"+img64;
};

window.removeBackground=()=>{
  if(!layers.length)return alert("Carga una imagen primero");
  alert("AquÃ­ se integra la eliminaciÃ³n de fondo con IA o servicio dedicado");
};

/* -------- Texto -------- */
window.addText=()=>{
  if(!txtContent.value)return;
  layers.push({
    type:"text",
    text:txtContent.value,
    x:100,y:200,
    size:+txtSize.value,
    color:txtColor.value
  });
  render();
};

/* -------- Plantillas -------- */
window.saveTemplate=()=>{
  localStorage.setItem("ITD_TEMPLATE",JSON.stringify(layers));
  alert("Plantilla guardada");
};
window.loadTemplate=()=>{
  const d=localStorage.getItem("ITD_TEMPLATE");
  if(!d)return alert("No hay plantilla");
  layers=JSON.parse(d);
  render();
};

/* -------- Utils -------- */
window.clearCanvas=()=>{layers=[];render();};

initAI();
render();
</script>

</body>
</html>
