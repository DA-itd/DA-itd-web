<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio de Diseño - ITD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1b396a;
            --accent: #d4a017;
            --maroon: #8B1538;
            --bg-dark: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-light: #f5f5f5;
            --border: #444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        .header {
            height: 50px;
            background: var(--primary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            border-bottom: 1px solid #000;
        }
        
        .header h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .back-link { color: white; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .back-link:hover { color: var(--accent); }

        /* MAIN LAYOUT */
        .workspace {
            display: flex;
            flex: 1;
            height: calc(100vh - 50px);
        }

        /* TOOLBAR (LEFT) */
        .toolbar {
            width: 60px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            gap: 15px;
            z-index: 10;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tool-btn.active { background: var(--accent); color: var(--primary); }
        .tool-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50px;
            background: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 20;
        }

        /* CANVAS AREA (CENTER) */
        .canvas-area {
            flex: 1;
            background: #111;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            padding: 20px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .canvas-area.drag-over {
            background-color: #2a2a2a;
            box-shadow: inset 0 0 0 4px var(--accent);
        }

        canvas {
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: default;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* PROPERTIES & LAYERS (RIGHT) */
        .sidebar {
            width: 300px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        /* CONTROLS */
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #ccc; }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            background: #222;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        input[type="color"] {
            width: 100%;
            height: 35px;
            border: none;
            background: none;
            cursor: pointer;
        }

        .btn-action {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-action:hover { filter: brightness(1.2); }
        .btn-action.secondary { background: #444; }
        
        /* New style for Local AI button */
        .btn-action.local-ai { 
            background: linear-gradient(135deg, #10b981, #059669); 
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        /* LAYER LIST */
        .layer-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #333;
            margin-bottom: 2px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .layer-item.selected {
            background: #444;
            border-left-color: var(--accent);
        }

        .layer-item i { margin-right: 10px; width: 15px; text-align: center; }
        .layer-name { flex: 1; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .layer-actions i { cursor: pointer; color: #666; font-size: 0.8rem; margin-left: 5px; }
        .layer-actions i:hover { color: #fff; }

        /* LOADING */
        .loader {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .loader.active { display: flex; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            align-items: center; justify-content: center; z-index: 200;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--panel-bg); padding: 25px; border-radius: 8px;
            width: 320px; border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-content h3 { margin-bottom: 20px; color: var(--text-light); text-align: center; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        /* RESIZE HANDLES */
        .resize-handle {
            position: absolute;
            width: 10px; height: 10px;
            background: white;
            border: 1px solid var(--primary);
            border-radius: 50%;
            pointer-events: none; /* Handle via logic */
        }
    </style>
</head>
<body>

    <div class="header">
        <h1><i class="fas fa-layer-group"></i> Estudio de Diseño <span style="font-size: 0.7rem; background: var(--accent); color: black; padding: 2px 6px; border-radius: 4px;">FREE</span></h1>
        
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver</a>
        </div>
    </div>

    <div class="workspace">
        <!-- TOOLBAR -->
        <div class="toolbar">
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()" data-tooltip="Subir Imagen"><i class="fas fa-upload"></i></button>
            <button class="tool-btn" onclick="addTextLayer()" data-tooltip="Añadir Texto"><i class="fas fa-font"></i></button>
            
            <div style="width: 30px; height: 1px; background: #555; margin: 5px 0;"></div>
            
            <button class="tool-btn" onclick="addShape('rect')" data-tooltip="Cuadro/Rectángulo"><i class="fas fa-vector-square"></i></button>
            <button class="tool-btn" onclick="addShape('circle')" data-tooltip="Círculo"><i class="fas fa-circle"></i></button>
            <button class="tool-btn" onclick="addShape('line')" data-tooltip="Línea"><i class="fas fa-minus"></i></button>
            
            <div style="width: 30px; height: 1px; background: #555; margin: 5px 0;"></div>
            
            <button class="tool-btn active" id="toolSelect" onclick="setTool('select')" data-tooltip="Mover/Seleccionar"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="toolEraser" onclick="removeBackgroundOfSelected()" data-tooltip="Quitar Fondo (IA Local)"><i class="fas fa-eraser" style="color: #10b981;"></i></button>
        </div>

        <!-- CANVAS -->
        <div class="canvas-area" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p id="loaderText" style="margin-top: 15px; text-align: center;">Iniciando IA...</p>
                <p id="loaderProgress" style="font-size: 0.8rem; color: #aaa; margin-top: 5px;"></p>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- PROPIEDADES -->
            <div class="panel-section">
                <div class="panel-title">Propiedades</div>
                <div id="propertiesPanel">
                    <p style="color: #666; font-size: 0.8rem; text-align: center;">Selecciona un elemento</p>
                </div>
            </div>

            <!-- CAPAS -->
            <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-title">
                    Capas
                    <div>
                        <i class="fas fa-arrow-up" style="cursor: pointer; margin-right: 5px;" onclick="moveLayer(-1)" title="Subir"></i>
                        <i class="fas fa-arrow-down" style="cursor: pointer;" onclick="moveLayer(1)" title="Bajar"></i>
                    </div>
                </div>
                <div class="layer-list" id="layerList">
                    <!-- Layer items injected here -->
                </div>
            </div>

            <!-- IA TOOLS -->
            <div class="panel-section">
                <div class="panel-title"><i class="fas fa-magic" style="color: #10b981;"></i> IA Local (Gratis)</div>
                <button class="btn-action local-ai" onclick="removeBackgroundOfSelected()">
                    <i class="fas fa-eraser"></i> Quitar Fondo
                </button>
                <p style="font-size: 0.7rem; color: #aaa; margin-top: 5px;">* Funciona en tu navegador. Modelo ModNet (~25MB).</p>
            </div>

            <!-- EXPORT -->
            <div class="panel-section">
                <button class="btn-action" onclick="openDownloadModal()"><i class="fas fa-download"></i> Descargar Diseño</button>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-download"></i> Descargar</h3>
            <div class="control-group">
                <label>Nombre del archivo</label>
                <input type="text" id="fileName" value="diseño_itd">
            </div>
            <div class="control-group">
                <label>Formato</label>
                <select id="fileFormat">
                    <option value="image/png">PNG (Fondo Transparente)</option>
                    <option value="image/jpeg">JPG (Fondo Blanco)</option>
                    <option value="image/webp">WebP (Alta Calidad)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-action secondary" onclick="closeDownloadModal()">Cancelar</button>
                <button class="btn-action" onclick="confirmDownload()">Guardar</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <!-- TRANSFORMERS.JS MODULE -->
    <script type="module">
        // Importación DIRECTA desde CDN
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';
        
        // Configuración crítica
        env.allowLocalModels = false; 
        env.useBrowserCache = true;   

        let segmenter = null;
        let isDownloading = false;

        window.initLocalModel = async () => {
            if (segmenter || isDownloading) return;
            isDownloading = true;

            const loader = document.getElementById('loader');
            const progressText = document.getElementById('loaderProgress');
            const mainText = document.getElementById('loaderText');
            
            try {
                console.log("Iniciando descarga del modelo IA (ModNet)...");
                
                const progressCallback = (x) => {
                    if (x.status === 'progress') {
                        const pct = Math.round(x.progress);
                        if (x.file.includes('onnx')) {
                             mainText.innerText = `Descargando IA...`;
                             progressText.innerText = `${pct}% completado`;
                             loader.classList.add('active');
                        }
                    } else if (x.status === 'initiate') {
                        loader.classList.add('active');
                        mainText.innerText = "Conectando...";
                    } else if (x.status === 'done') {
                         mainText.innerText = "Cargando...";
                    }
                };

                // CAMBIO IMPORTANTE: Usamos 'image-matting' y 'Xenova/modnet'
                // Este modelo es público, ligero y específico para quitar fondos
                segmenter = await pipeline('image-matting', 'Xenova/modnet', {
                    progress_callback: progressCallback
                });
                
                console.log("Modelo ModNet cargado y listo.");
                loader.classList.remove('active');
                
            } catch (e) {
                console.error("Error crítico cargando Transformers.js:", e);
                loader.classList.remove('active');
                segmenter = null;
                alert("Error al cargar el modelo IA:\n" + e.message + "\n\nVerifica tu conexión.");
            } finally {
                isDownloading = false;
            }
        }
        
        window.initLocalModel().catch(e => console.log("Precarga fallida"));
        
        window.getSegmenter = async () => {
            if (!segmenter) {
                await window.initLocalModel();
            }
            if (!segmenter) {
                throw new Error("No se pudo inicializar el motor de IA.");
            }
            return segmenter;
        }
    </script>

    <script>
        // ==========================================
        // ENGINE STATE
        // ==========================================
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 800;
        canvas.height = 600;

        let layers = []; 
        let selectedLayerId = null;
        
        // Mouse State
        let isDragging = false;
        let isResizing = false;
        let dragStart = { x: 0, y: 0 };
        const HANDLE_SIZE = 12;

        // ==========================================
        // UTILS
        // ==========================================
        
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) * (canvas.width / rect.width),
                y: (evt.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function isHandleClicked(layer, mx, my) {
            if (!layer) return false;
            const hx = layer.x + layer.width - HANDLE_SIZE/2;
            const hy = layer.y + layer.height - HANDLE_SIZE/2;
            return mx >= hx && mx <= hx + HANDLE_SIZE && my >= hy && my <= hy + HANDLE_SIZE;
        }

        // ==========================================
        // CORE RENDER LOOP
        // ==========================================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            layers.forEach(layer => {
                if (!layer.visible) return;
                
                ctx.save();
                const cx = layer.x + layer.width / 2;
                const cy = layer.y + layer.height / 2;
                ctx.translate(cx, cy);
                ctx.rotate(layer.rotation * Math.PI / 180);
                ctx.translate(-cx, -cy);

                ctx.globalAlpha = layer.opacity !== undefined ? layer.opacity : 1;

                if (layer.type === 'image') {
                    if (layer.imgElement) {
                        ctx.drawImage(layer.imgElement, layer.x, layer.y, layer.width, layer.height);
                    }
                } else if (layer.type === 'shape') {
                    ctx.fillStyle = layer.color;
                    if (layer.shapeType === 'rect') {
                        ctx.fillRect(layer.x, layer.y, layer.width, layer.height);
                    } else if (layer.shapeType === 'circle') {
                        ctx.beginPath();
                        ctx.ellipse(cx, cy, layer.width/2, layer.height/2, 0, 0, 2 * Math.PI);
                        ctx.fill();
                    } else if (layer.shapeType === 'line') {
                        ctx.fillRect(layer.x, layer.y, layer.width, layer.height);
                    }
                } else if (layer.type === 'text') {
                    ctx.font = `${layer.fontSize}px ${layer.fontFamily}`;
                    ctx.fillStyle = layer.color;
                    ctx.textBaseline = 'top';
                    ctx.fillText(layer.content, layer.x, layer.y);
                    const metrics = ctx.measureText(layer.content);
                    layer.width = metrics.width;
                    layer.height = layer.fontSize; 
                }

                ctx.globalAlpha = 1;

                if (layer.id === selectedLayerId) {
                    ctx.strokeStyle = '#d4a017';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(layer.x, layer.y, layer.width, layer.height);
                    
                    ctx.fillStyle = '#d4a017';
                    const hSize = HANDLE_SIZE;
                    ctx.fillRect(layer.x + layer.width - hSize/2, layer.y + layer.height - hSize/2, hSize, hSize);
                }

                ctx.restore();
            });
        }

        // ==========================================
        // LAYER MANAGEMENT
        // ==========================================
        function createId() { return Math.random().toString(36).substr(2, 9); }

        window.addLayer = (layerData) => {
            const newLayer = {
                id: createId(),
                x: 50, y: 50,
                width: 100, height: 100,
                rotation: 0,
                visible: true,
                opacity: 1,
                ...layerData
            };
            layers.push(newLayer);
            selectedLayerId = newLayer.id;
            updateUI();
            render();
        };

        window.addTextLayer = (content = 'Texto Nuevo') => {
            window.addLayer({
                type: 'text',
                content: content,
                fontSize: 40,
                fontFamily: 'Arial',
                color: '#ffffff',
                width: 100, height: 40
            });
        };

        window.addShape = (shapeType) => {
            let width = 150;
            let height = 150;
            if (shapeType === 'line') { width = 200; height = 5; }
            window.addLayer({ type: 'shape', shapeType: shapeType, color: '#1b396a', width: width, height: height });
        };

        const handleImageUpload = (file) => {
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        if (layers.length === 0) { canvas.width = img.width; canvas.height = img.height; }
                        window.addLayer({ type: 'image', imgElement: img, width: img.width, height: img.height, x: 0, y: 0 });
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const input = e.target;
            if (input.files && input.files[0]) { handleImageUpload(input.files[0]); input.value = ''; }
        });

        const dropZone = document.getElementById('canvasContainer');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) handleImageUpload(files[0]);
        });

        window.removeLayer = (id) => {
            layers = layers.filter(l => l.id !== id);
            if (selectedLayerId === id) selectedLayerId = null;
            updateUI(); render();
        };

        window.moveLayer = (dir) => {
            if (!selectedLayerId) return;
            const idx = layers.findIndex(l => l.id === selectedLayerId);
            if (idx === -1) return;
            const newIdx = idx + dir;
            if (newIdx >= 0 && newIdx < layers.length) { [layers[idx], layers[newIdx]] = [layers[newIdx], layers[idx]]; updateUI(); render(); }
        };

        window.selectLayer = (id) => { selectedLayerId = id; updateUI(); render(); };

        // ==========================================
        // UI UPDATES
        // ==========================================
        function updateUI() {
            const list = document.getElementById('layerList');
            list.innerHTML = '';
            [...layers].reverse().forEach(layer => {
                const div = document.createElement('div');
                div.className = `layer-item ${layer.id === selectedLayerId ? 'selected' : ''}`;
                div.onclick = () => window.selectLayer(layer.id);
                
                let icon = 'fa-layer-group';
                let name = 'Capa';
                if (layer.type === 'text') { icon = 'fa-font'; name = layer.content; }
                if (layer.type === 'image') { icon = 'fa-image'; name = 'Imagen'; }
                if (layer.type === 'shape') { icon = 'fa-shapes'; name = 'Forma'; }

                div.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span class="layer-name">${name}</span>
                    <div class="layer-actions">
                        <i class="fas fa-eye${layer.visible ? '' : '-slash'}" onclick="event.stopPropagation(); toggleVis('${layer.id}')"></i>
                        <i class="fas fa-trash" onclick="event.stopPropagation(); removeLayer('${layer.id}')"></i>
                    </div>
                `;
                list.appendChild(div);
            });

            const propsPanel = document.getElementById('propertiesPanel');
            const selLayer = layers.find(l => l.id === selectedLayerId);
            
            if (!selLayer) {
                propsPanel.innerHTML = '<p style="color: #666; font-size: 0.8rem; text-align: center;">Selecciona un elemento</p>';
                return;
            }

            let html = `<div class="control-group"><label>Opacidad</label><input type="range" min="0" max="1" step="0.1" value="${selLayer.opacity !== undefined ? selLayer.opacity : 1}" oninput="updateProp('opacity', this.value)"></div>`;

            if (selLayer.type === 'text') {
                html += `
                    <div class="control-group"><label>Texto</label><input type="text" value="${selLayer.content}" oninput="updateProp('content', this.value)"></div>
                    <div class="control-group"><label>Tamaño</label><input type="number" value="${selLayer.fontSize}" oninput="updateProp('fontSize', this.value)"></div>
                    <div class="control-group"><label>Color</label><input type="color" value="${selLayer.color}" oninput="updateProp('color', this.value)"></div>
                `;
            } else if (selLayer.type === 'shape') {
                html += `
                    <div class="control-group"><label>Color</label><input type="color" value="${selLayer.color}" oninput="updateProp('color', this.value)"></div>
                    <div class="control-group"><label>Ancho</label><input type="number" value="${selLayer.width}" oninput="updateProp('width', this.value)"></div>
                    <div class="control-group"><label>Alto</label><input type="number" value="${selLayer.height}" oninput="updateProp('height', this.value)"></div>
                `;
            } else if (selLayer.type === 'image') {
                 html += `
                    <div class="control-group"><label>Ancho</label><input type="number" value="${parseInt(selLayer.width)}" oninput="updateProp('width', this.value)"></div>
                    <div class="control-group"><label>Alto</label><input type="number" value="${parseInt(selLayer.height)}" oninput="updateProp('height', this.value)"></div>
                `;
            }
            propsPanel.innerHTML = html;
        }

        window.updateProp = (key, value) => {
            const layer = layers.find(l => l.id === selectedLayerId);
            if (layer) {
                if (['width','height','fontSize'].includes(key)) value = parseInt(value);
                if (key === 'opacity') value = parseFloat(value);
                layer[key] = value; render();
            }
        };

        window.toggleVis = (id) => {
            const layer = layers.find(l => l.id === id);
            if (layer) { layer.visible = !layer.visible; updateUI(); render(); }
        };

        // ==========================================
        // MOUSE EVENTS
        // ==========================================
        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            if (selectedLayerId) {
                const layer = layers.find(l => l.id === selectedLayerId);
                if (layer && isHandleClicked(layer, pos.x, pos.y)) {
                    isResizing = true; isDragging = false; dragStart = { x: pos.x, y: pos.y }; return;
                }
            }
            let hit = false;
            for (let i = layers.length - 1; i >= 0; i--) {
                const l = layers[i];
                if (!l.visible) continue;
                if (pos.x >= l.x && pos.x <= l.x + l.width && pos.y >= l.y && pos.y <= l.y + l.height) {
                    selectedLayerId = l.id; isDragging = true; isResizing = false; dragStart = { x: pos.x - l.x, y: pos.y - l.y }; hit = true; updateUI(); render(); break;
                }
            }
            if (!hit) { selectedLayerId = null; isDragging = false; updateUI(); render(); }
        });

        canvas.addEventListener('mousemove', (e) => {
            const pos = getMousePos(e);
            let cursor = 'default';
            if (isResizing) cursor = 'nwse-resize';
            else if (selectedLayerId) {
                const layer = layers.find(l => l.id === selectedLayerId);
                if (isHandleClicked(layer, pos.x, pos.y)) cursor = 'nwse-resize';
                else if (pos.x >= layer.x && pos.x <= layer.x + layer.width && pos.y >= layer.y && pos.y <= layer.y + layer.height) cursor = 'move';
            }
            canvas.style.cursor = cursor;

            if (isResizing && selectedLayerId) {
                const layer = layers.find(l => l.id === selectedLayerId);
                if (layer) { layer.width = Math.max(20, pos.x - layer.x); layer.height = Math.max(20, pos.y - layer.y); updateUI(); render(); }
            } else if (isDragging && selectedLayerId) {
                const layer = layers.find(l => l.id === selectedLayerId);
                if (layer) { layer.x = pos.x - dragStart.x; layer.y = pos.y - dragStart.y; render(); }
            }
        });

        window.addEventListener('mouseup', () => { isDragging = false; isResizing = false; });

        // ==========================================
        // LOCAL AI - BACKGROUND REMOVAL (GRATIS)
        // ==========================================
        
        window.removeBackgroundOfSelected = async () => {
            let layer = layers.find(l => l.id === selectedLayerId);
            
            if (!layer || layer.type !== 'image') {
                const imageLayers = layers.filter(l => l.type === 'image');
                if (imageLayers.length > 0) {
                    layer = imageLayers[imageLayers.length - 1];
                    selectedLayerId = layer.id;
                    updateUI(); render();
                } else {
                    alert('Por favor, selecciona o sube una imagen primero.');
                    return;
                }
            }

            const loader = document.getElementById('loader');
            loader.classList.add('active');
            document.getElementById('loaderText').innerText = 'Procesando...';
            document.getElementById('loaderProgress').innerText = '';

            try {
                // Obtener el modelo local (asegura que esté cargado)
                const segmenter = await window.getSegmenter();
                
                document.getElementById('loaderText').innerText = 'Analizando imagen...';

                // Preparar imagen
                const tempC = document.createElement('canvas');
                tempC.width = layer.imgElement.naturalWidth;
                tempC.height = layer.imgElement.naturalHeight;
                const tempCtx = tempC.getContext('2d');
                tempCtx.drawImage(layer.imgElement, 0, 0);
                
                // Ejecutar Transformers.js (Inferencia)
                // Para image-matting el output suele ser [{ mask: RawImage }]
                const output = await segmenter(tempC.toDataURL());
                
                // Extraer la máscara
                // Puede venir como output[0].mask o output.mask dependiendo de la versión exacta de la task.
                // ModNet devuelve normalmente una máscara de transparencia.
                let mask = output[0] ? output[0].mask : output.mask;
                
                if (!mask) throw new Error("No se pudo generar la máscara.");

                // Componer la imagen final
                // 1. Convertir máscara a Canvas
                const maskCanvas = document.createElement('canvas');
                maskCanvas.width = mask.width;
                maskCanvas.height = mask.height;
                const maskCtx = maskCanvas.getContext('2d');
                
                // Convertir RawImage data a ImageData
                const maskData = new ImageData(new Uint8ClampedArray(mask.data), mask.width, mask.height);
                maskCtx.putImageData(maskData, 0, 0);

                // 2. Aplicar la máscara a la imagen original
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = tempC.width;
                finalCanvas.height = tempC.height;
                const finalCtx = finalCanvas.getContext('2d');

                // Dibujar imagen original
                finalCtx.drawImage(tempC, 0, 0, finalCanvas.width, finalCanvas.height);
                
                // Usar composición para aplicar la máscara alfa
                // 'destination-in' mantiene el contenido original donde la nueva imagen (máscara) es opaca
                // NOTA: Para ModNet, la máscara es blanca donde es primer plano, negra fondo.
                // Funciona perfecto con destination-in.
                finalCtx.globalCompositeOperation = 'destination-in';
                finalCtx.drawImage(maskCanvas, 0, 0, finalCanvas.width, finalCanvas.height);

                // 3. Actualizar la capa con la nueva imagen sin fondo
                const finalImg = new Image();
                finalImg.onload = () => {
                    layer.imgElement = finalImg;
                    loader.classList.remove('active');
                    render();
                };
                finalImg.src = finalCanvas.toDataURL();

            } catch (error) {
                console.error(error);
                alert('Error al procesar: ' + (error.message || error));
                loader.classList.remove('active');
            }
        };

        // ==========================================
        // DOWNLOAD MODAL
        // ==========================================
        window.openDownloadModal = () => document.getElementById('downloadModal').classList.add('active');
        window.closeDownloadModal = () => document.getElementById('downloadModal').classList.remove('active');
        window.confirmDownload = () => {
            const fileName = document.getElementById('fileName').value || 'diseño_itd';
            const format = document.getElementById('fileFormat').value;
            const currentSelection = selectedLayerId;
            selectedLayerId = null; render(); 
            
            const link = document.createElement('a');
            if (format === 'image/jpeg') {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.fillStyle = '#ffffff'; tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tCtx.drawImage(canvas, 0, 0);
                link.download = `${fileName}.jpg`; link.href = tempCanvas.toDataURL('image/jpeg', 0.9);
            } else {
                const ext = format === 'image/webp' ? 'webp' : 'png';
                link.download = `${fileName}.${ext}`; link.href = canvas.toDataURL(format);
            }
            link.click();
            selectedLayerId = currentSelection; render(); closeDownloadModal();
        };

        render();
    </script>
</body>
</html>
