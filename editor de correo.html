<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador ITD v22 (Fixed)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1b396a; --accent: #d4a017; --bg: #f8fafc; --panel: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg); color: #333; overflow: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* --- PANEL IZQUIERDO --- */
        .controls { width: 500px; background: var(--panel); border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 10; }
        
        .header-panel { padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-panel h2 { margin: 0; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }

        /* BOTONES DE GUARDADO */
        .save-load-group { display: flex; gap: 5px; }
        .btn-file { padding: 5px 10px; font-size: 0.75rem; cursor: pointer; border: 1px solid #cbd5e1; background: #f1f5f9; border-radius: 4px; display: flex; align-items: center; gap: 5px; color: #555; }
        .btn-file:hover { background: #e2e8f0; color: var(--primary); }

        /* BANCO DE LOGOS */
        .logo-bank { background: #f1f5f9; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 10px; }
        .logo-label { font-size: 0.7rem; font-weight: bold; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .logo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 8px; }
        .logo-option { 
            height: 50px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; transition: 0.2s; position: relative;
        }
        .logo-option:hover { border-color: var(--primary); background: #e0f2fe; }
        .logo-option img { max-height: 80%; max-width: 90%; object-fit: contain; }
        .logo-option span { position: absolute; bottom: 0px; right: 2px; font-size: 14px; color: var(--primary); font-weight: bold; }
        
        .manual-url-input { display: flex; gap: 5px; }
        .manual-url-input input { flex: 1; }
        .manual-url-input button { padding: 0 10px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 4px; }

        /* LISTA DE BLOQUES */
        #blocks-container { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }

        .block-card { background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 12px; margin-bottom: 12px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; background: #f8fafc; margin: -12px -12px 10px -12px; padding: 8px 12px; border-radius: 6px 6px 0 0; }
        .block-title { font-weight: bold; font-size: 0.75rem; color: var(--primary); text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        
        .move-controls { display: flex; gap: 2px; }
        .btn-move { border: 1px solid #ddd; background: white; color: #555; cursor: pointer; padding: 2px 6px; font-size: 0.7rem; border-radius: 3px; }
        .btn-move:hover { background: #eee; }
        .btn-delete { color: #ef4444; cursor: pointer; margin-left: 10px; font-size: 0.9rem; }

        /* Estilos 2 columnas */
        .cols-editor { display: flex; gap: 5px; }
        .col-panel { flex: 1; background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .col-label { font-size: 0.7rem; font-weight: bold; color: var(--primary); margin-bottom: 4px; display: block; }

        /* BOTON SWAP */
        .btn-swap {
            width: 30px; height: 30px; border-radius: 50%; border: 1px solid #cbd5e1; background: white; 
            color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; align-self: center; margin-bottom: 4px;
        }
        .btn-swap:hover { background: var(--primary); color: white; border-color: var(--primary); transform: rotate(180deg); }

        /* EDITOR TOOLBAR */
        .editor-toolbar { background:#f1f5f9; padding:5px; margin-bottom:5px; border-radius:4px; display:flex; gap:5px; align-items: center;}
        .editor-toolbar button { cursor:pointer; font-size: 0.8rem; padding: 4px 8px; border: 1px solid #cbd5e1; background: white; border-radius: 3px; display: flex; align-items: center; gap: 4px;}
        .editor-toolbar button:hover { background: #e2e8f0; }

        /* INPUTS */
        label { font-size: 0.7rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 2px; margin-top: 6px; }
        input[type="text"], textarea, select { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; font-family: inherit; box-sizing: border-box;}
        input[type="range"] { width: 100%; cursor: pointer; margin: 5px 0; }
        textarea { resize: vertical; min-height: 60px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* BOTONES ACCION */
        .add-buttons { padding: 10px; background: white; border-top: 1px solid #ddd; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-add { padding: 8px; border: 1px solid #cbd5e1; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: #475569; display: flex; flex-direction: column; align-items: center; gap: 3px; transition: 0.2s; }
        .btn-add:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }
        
        .btn-special { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

        .btn-copy { grid-column: span 4; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 5px; }
        .btn-copy:hover { background-color: #142d55; }

        /* PREVIEW AREA */
        .preview-area { flex: 1; padding: 30px; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }
        
    </style>
</head>
<body>

    <div class="controls">
        <div class="header-panel">
            <div class="header-top">
                <h2>Generador v22 (Fixed)</h2>
                <div class="save-load-group">
                    <button class="btn-file" onclick="saveTemplate()"><i class="fas fa-save"></i> Guardar</button>
                    <button class="btn-file" onclick="document.getElementById('fileInput').click()"><i class="fas fa-folder-open"></i> Cargar</button>
                    <input type="file" id="fileInput" style="display:none" onchange="loadTemplate(this)" accept=".json">
                </div>
            </div>
            
            <div class="logo-bank">
                <span class="logo-label">A√±adir Logo R√°pido (+):</span>
                <div class="logo-grid">
                    <div class="logo-option" onclick="addLogoBlock('https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png')"><img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png"><span>+</span></div>
                    <div class="logo-option" onclick="addLogoBlock('https://raw.githubusercontent.com/DA-itd/web/main/pola.png')"><img src="https://raw.githubusercontent.com/DA-itd/web/main/pola.png"><span>+</span></div>
                    <div class="logo-option" onclick="addLogoBlock('https://raw.githubusercontent.com/DA-itd/web/main/TecNM.jpg')"><img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM.jpg"><span>+</span></div>
                    <div class="logo-option" onclick="addLogoBlock('https://raw.githubusercontent.com/DA-itd/A/main/tecnm1.jpg')"><img src="https://raw.githubusercontent.com/DA-itd/A/main/tecnm1.jpg"><span>+</span></div>
                </div>
                <div class="manual-url-input">
                    <input type="text" id="manualLogoUrl" placeholder="O pega otra URL aqu√≠...">
                    <button onclick="addManualLogo()">A√±adir</button>
                </div>
            </div>

            <label>Color Institucional (Barras Sup/Inf)</label>
            <input type="color" id="accentColor" value="#1b396a" oninput="renderPreview(); saveData();" style="width:100%; height:30px; border:none; cursor:pointer;">
        </div>

        <div id="blocks-container"></div>

        <div class="add-buttons">
            <button class="btn-add btn-special" onclick="addBlock('header_tri')"><i class="fas fa-university"></i> <b>Encabezado Oficial</b></button>
            <button class="btn-add" onclick="addBlock('text')"><i class="fas fa-font"></i> Texto</button>
            <button class="btn-add" onclick="addBlock('columns')"><i class="fas fa-columns"></i> 2 Cols</button>
            <button class="btn-add" onclick="addBlock('image')"><i class="fas fa-image"></i> Imagen</button>
            <button class="btn-add" onclick="addBlock('box')"><i class="fas fa-square"></i> Caja</button>
            <button class="btn-add" onclick="addBlock('button')"><i class="fas fa-link"></i> Bot√≥n</button>
            <button class="btn-add" onclick="addBlock('separator')"><i class="fas fa-minus"></i> L√≠nea</button>
            <button class="btn-add" onclick="addBlock('html')"><i class="fas fa-code"></i> HTML</button>
            
            <button class="btn-copy" onclick="copyToClipboard()"><i class="fas fa-copy"></i> COPIAR CORREO</button>
            <p id="msg" style="grid-column: span 4; text-align: center; color: green; display: none; margin: 0; font-size: 0.8rem;">¬°Copiado! P√©galo en Gmail.</p>
        </div>
    </div>

    <div class="preview-area">
        <div id="copy-target">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f1f5f9; font-family: Arial, sans-serif;">
                <tr>
                    <td align="center" style="padding: 20px;">
                        <table width="600" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            
                            <tr><td height="6" class="preview-accent-line" style="background-color: #1b396a; font-size: 0;">&nbsp;</td></tr>
                            
                            <tr>
                                <td style="padding: 0;">
                                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tbody id="preview-content"></tbody>
                                    </table>
                                </td>
                            </tr>
                            
                            <tr>
                                <td align="center" style="background-color: #f8fafc; padding: 20px 20px 15px 20px; font-size: 11px; color: #64748b; border-top: 1px solid #e2e8f0;">
                                    <p style="margin: 0;">Desarrollado en la coordinaci√≥n de actualizacion docente / Alex</p>
                                </td>
                            </tr>

                            <tr><td height="6" class="preview-accent-line" style="background-color: #1b396a; font-size: 0;">&nbsp;</td></tr>

                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        // --- DATA INICIAL ---
        let blocks = [
            { 
                type: 'header_tri', 
                logo1: 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png', 
                logo2: 'https://raw.githubusercontent.com/DA-itd/A/main/tecnm1.jpg', 
                line1: 'INSTITUTO TECNOL√ìGICO DE DURANGO',
                line2: 'Departamento de Desarrollo Acad√©mico',
                logoWidth: 60
            },
            { type: 'text', content: 'Inicia tu correo aqu√≠.' }
        ];

        // RECUPERAR
        const savedData = localStorage.getItem('itd_email_v22');
        if(savedData) {
            try {
                const parsed = JSON.parse(savedData);
                if(parsed.blocks) { blocks = parsed.blocks; document.getElementById('accentColor').value = parsed.accentColor || '#1b396a'; }
            } catch(e) { }
        }

        // --- CORE FUNCTIONS ---
        function saveData() { localStorage.setItem('itd_email_v22', JSON.stringify({ blocks: blocks, accentColor: document.getElementById('accentColor').value })); }
        function saveTemplate() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ blocks: blocks, accentColor: document.getElementById('accentColor').value }));
            const a = document.createElement('a'); a.href = dataStr; a.download = "plantilla_itd.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        function loadTemplate(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.blocks) { blocks = data.blocks; document.getElementById('accentColor').value = data.accentColor || '#1b396a'; renderControls(); renderPreview(); saveData(); alert('Cargado correctamente.'); }
                } catch(err) { alert('Error de archivo.'); }
            };
            reader.readAsText(file); input.value = '';
        }
        function fixGithubUrl(url) { if(url && url.includes('github.com') && url.includes('/blob/')) return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/'); return url; }

        // --- UPDATE BLOCKS ---
        function addBlock(type) {
            let newBlock = { type: type };
            if(type === 'text') { newBlock.content = 'Escribe aqu√≠...'; newBlock.align = 'left'; }
            if(type === 'box') { newBlock.content = 'DESTACADO'; newBlock.bgColor = '#e0f2fe'; newBlock.textColor = '#0c4a6e'; newBlock.align = 'center'; }
            if(type === 'image') { newBlock.url = ''; newBlock.align = 'center'; newBlock.width = 100; }
            if(type === 'button') { newBlock.text = 'Click'; newBlock.btnColor = '#1b396a'; }
            if(type === 'columns') { newBlock.col1Type = 'text'; newBlock.col1Content = 'Izq...'; newBlock.col1Align = 'left'; newBlock.col1Width = 100; newBlock.col2Type = 'text'; newBlock.col2Content = 'Der...'; newBlock.col2Align = 'left'; newBlock.col2Width = 100; }
            if(type === 'separator') { newBlock.color = '#cbd5e1'; newBlock.width = 90; newBlock.thickness = 2; newBlock.style = 'solid'; }
            
            if(type === 'header_tri') {
                newBlock.logo1 = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';
                newBlock.logo2 = 'https://raw.githubusercontent.com/DA-itd/A/main/tecnm1.jpg';
                newBlock.line1 = 'INSTITUTO TECNOL√ìGICO DE DURANGO';
                newBlock.line2 = 'Departamento de Desarrollo Acad√©mico';
                newBlock.logoWidth = 60;
            }

            blocks.push(newBlock); renderControls(); renderPreview(); saveData();
            setTimeout(() => { document.getElementById('blocks-container').scrollTop = 9999; }, 100);
        }
        
        function addLogoBlock(url) { blocks.push({ type: 'image', url: fixGithubUrl(url), align: 'center', width: 100 }); renderControls(); renderPreview(); saveData(); }
        function addManualLogo() { const url = document.getElementById('manualLogoUrl').value.trim(); if(url) { addLogoBlock(url); document.getElementById('manualLogoUrl').value = ''; } }
        function removeBlock(index) { blocks.splice(index, 1); renderControls(); renderPreview(); saveData(); }
        function moveBlock(index, dir) { if ((dir === -1 && index > 0) || (dir === 1 && index < blocks.length - 1)) { [blocks[index], blocks[index + dir]] = [blocks[index + dir], blocks[index]]; renderControls(); renderPreview(); saveData(); } }
        
        function swapColumns(index) {
            const b = blocks[index];
            [b.col1Type, b.col2Type] = [b.col2Type, b.col1Type];
            [b.col1Content, b.col2Content] = [b.col2Content, b.col1Content];
            [b.col1Width, b.col2Width] = [b.col2Width, b.col1Width];
            renderControls(); renderPreview(); saveData();
        }

        function swapHeaderLogos(index) {
            const b = blocks[index];
            [b.logo1, b.logo2] = [b.logo2, b.logo1];
            renderControls(); renderPreview(); saveData();
        }

        function updateBlockLayout(index, key, value) { blocks[index][key] = value; renderControls(); renderPreview(); saveData(); }
        function updateBlock(index, key, value) { blocks[index][key] = value; renderPreview(); saveData(); }
        function execFormat(cmd) { document.execCommand(cmd, false, null); }
        function execClean() { document.execCommand('removeFormat', false, null); }

        // --- RENDER CONTROLES ---
        function renderControls() {
            const container = document.getElementById('blocks-container');
            container.innerHTML = '';
            blocks.forEach((block, index) => {
                let html = `<div class="block-card"><div class="block-header"><div class="block-title"><i class="fas fa-cube"></i> ${block.type.toUpperCase()}</div><div style="display:flex; align-items:center;"><div class="move-controls"><button class="btn-move" onclick="moveBlock(${index}, -1)">‚ñ≤</button><button class="btn-move" onclick="moveBlock(${index}, 1)">‚ñº</button></div><i class="fas fa-trash-alt btn-delete" onclick="removeBlock(${index})"></i></div></div>`;

                if (block.type === 'text') {
                    html += `<select onchange="updateBlock(${index}, 'align', this.value)" style="margin-bottom:5px;"><option value="left" ${block.align==='left'?'selected':''}>Izquierda</option><option value="center" ${block.align==='center'?'selected':''}>Centro</option><option value="right" ${block.align==='right'?'selected':''}>Derecha</option><option value="justify" ${block.align==='justify'?'selected':''}>Justificado</option></select><div class="editor-toolbar"><button onmousedown="event.preventDefault(); execFormat('bold')" title="Negrita"><b>B</b></button> <button onmousedown="event.preventDefault(); execFormat('italic')" title="Cursiva"><i>I</i></button> <button onmousedown="event.preventDefault(); execClean()" title="Limpiar Formato para aplicar Color">üßπ Limpiar</button></div><div contenteditable="true" style="min-height:60px; border:1px solid #cbd5e1; padding:8px; background:white; color:#333;" oninput="updateBlock(${index}, 'content', this.innerHTML)">${block.content}</div>`;
                }
                else if (block.type === 'box') {
                    html += `<div class="row"> <div class="col"><label>Fondo</label><input type="color" value="${block.bgColor||'#e0f2fe'}" oninput="updateBlock(${index},'bgColor',this.value)"></div> <div class="col"><label>Texto</label><input type="color" value="${block.textColor||'#1e3a8a'}" oninput="updateBlock(${index},'textColor',this.value)"></div> </div><div class="row"><div class="col"><label>Alineaci√≥n</label><select onchange="updateBlock(${index}, 'align', this.value)"><option value="left" ${block.align==='left'?'selected':''}>Izquierda</option><option value="center" ${block.align==='center'?'selected':''}>Centro</option><option value="right" ${block.align==='right'?'selected':''}>Derecha</option><option value="justify" ${block.align==='justify'?'selected':''}>Justificado</option></select></div></div><div class="editor-toolbar"><button onmousedown="event.preventDefault(); execFormat('bold')" title="Negrita"><b>B</b></button> <button onmousedown="event.preventDefault(); execFormat('italic')" title="Cursiva"><i>I</i></button> <button onmousedown="event.preventDefault(); execClean()" title="Limpiar Formato para aplicar Color">üßπ Limpiar</button></div><div contenteditable="true" style="min-height:60px; border:1px solid #cbd5e1; padding:8px; background:white; color:#333;" oninput="updateBlock(${index}, 'content', this.innerHTML)">${block.content}</div>`;
                }
                else if (block.type === 'header_tri') {
                    html += `
                    <div style="background:#eff6ff; padding:10px; border:1px solid #bfdbfe; border-radius:4px;">
                        <div style="display:flex; align-items:flex-end; gap:5px;">
                            <div style="flex:1"><label>Logo Izq</label><input type="text" value="${block.logo1}" oninput="updateBlock(${index}, 'logo1', this.value)"></div>
                            <button class="btn-swap" onclick="swapHeaderLogos(${index})" style="margin-bottom:4px;" title="Intercambiar Logos"><i class="fas fa-exchange-alt"></i></button>
                            <div style="flex:1"><label>Logo Der</label><input type="text" value="${block.logo2}" oninput="updateBlock(${index}, 'logo2', this.value)"></div>
                        </div>
                        <label>L√≠nea 1 (Instituci√≥n - Negrita)</label>
                        <input type="text" value="${block.line1}" oninput="updateBlock(${index}, 'line1', this.value)" style="font-weight:bold;">
                        <label>L√≠nea 2 (Departamento)</label>
                        <input type="text" value="${block.line2}" oninput="updateBlock(${index}, 'line2', this.value)">
                        <label>Tama√±o Logos: ${block.logoWidth||60}%</label>
                        <input type="range" min="20" max="100" value="${block.logoWidth||60}" oninput="updateBlock(${index}, 'logoWidth', this.value)">
                    </div>`;
                }
                else if (block.type === 'columns') {
                    html += `<div class="cols-editor"><div class="col-panel"><span class="col-label">‚¨ÖÔ∏è Izquierda</span> <select onchange="updateBlockLayout(${index}, 'col1Type', this.value)" style="margin-bottom:5px;"><option value="image" ${block.col1Type==='image'?'selected':''}>Imagen</option><option value="text" ${block.col1Type==='text'?'selected':''}>Texto</option></select> ${block.col1Type==='image' ? `<input type="text" value="${block.col1Content}" oninput="updateBlock(${index}, 'col1Content', this.value)" placeholder="URL Imagen"> <select onchange="updateBlock(${index}, 'col1Align', this.value)" style="margin-top:5px;"><option value="left" ${block.col1Align==='left'?'selected':''}>Izq</option><option value="center" ${block.col1Align==='center'?'selected':''}>Cen</option><option value="right" ${block.col1Align==='right'?'selected':''}>Der</option></select> <label>Tama√±o: ${block.col1Width||100}%</label> <input type="range" min="10" max="100" value="${block.col1Width||100}" oninput="updateBlock(${index}, 'col1Width', this.value)">` : `<textarea oninput="updateBlock(${index}, 'col1Content', this.value)">${block.col1Content}</textarea>`}</div> <div style="display:flex; align-items:center;"><button class="btn-swap" onclick="swapColumns(${index})"><i class="fas fa-exchange-alt"></i></button></div> <div class="col-panel"><span class="col-label">‚û°Ô∏è Derecha</span> <select onchange="updateBlockLayout(${index}, 'col2Type', this.value)" style="margin-bottom:5px;"><option value="image" ${block.col2Type==='image'?'selected':''}>Imagen</option><option value="text" ${block.col2Type==='text'?'selected':''}>Texto</option></select> ${block.col2Type==='image' ? `<input type="text" value="${block.col2Content}" oninput="updateBlock(${index}, 'col2Content', this.value)" placeholder="URL Imagen"> <select onchange="updateBlock(${index}, 'col2Align', this.value)" style="margin-top:5px;"><option value="left" ${block.col2Align==='left'?'selected':''}>Izq</option><option value="center" ${block.col2Align==='center'?'selected':''}>Cen</option><option value="right" ${block.col2Align==='right'?'selected':''}>Der</option></select> <label>Tama√±o: ${block.col2Width||100}%</label> <input type="range" min="10" max="100" value="${block.col2Width||100}" oninput="updateBlock(${index}, 'col2Width', this.value)">` : `<textarea oninput="updateBlock(${index}, 'col2Content', this.value)">${block.col2Content}</textarea>`}</div></div>`;
                }
                else if (block.type === 'image') { html += `<label>URL Imagen:</label> <input type="text" value="${block.url||''}" oninput="updateBlock(${index}, 'url', this.value)"> <div class="row"> <div class="col"><label>Alineaci√≥n</label><select onchange="updateBlock(${index}, 'align', this.value)"><option value="left" ${block.align==='left'?'selected':''}>Izquierda</option><option value="center" ${block.align==='center'?'selected':''}>Centro</option><option value="right" ${block.align==='right'?'selected':''}>Derecha</option></select></div> <div class="col"><label>Tama√±o (%)</label><input type="range" min="10" max="100" value="${block.width||100}" oninput="updateBlock(${index}, 'width', this.value)"></div> </div>`; }
                else if (block.type === 'html') { html += `<textarea style="background:#1e293b; color:#a5b4fc; font-family:monospace;" oninput="updateBlock(${index}, 'content', this.value)">${block.content}</textarea>`; }
                else if (block.type === 'separator') { html += `<div class="row"><div class="col"><label>Color</label><input type="color" value="${block.color||'#cbd5e1'}" oninput="updateBlock(${index}, 'color', this.value)"></div><div class="col"><label>Estilo</label><select onchange="updateBlock(${index}, 'style', this.value)"><option value="solid" ${block.style==='solid'?'selected':''}>S√≥lida</option><option value="dashed" ${block.style==='dashed'?'selected':''}>Guiones</option><option value="dotted" ${block.style==='dotted'?'selected':''}>Puntos</option></select></div></div><div class="row"><div class="col"><label>Ancho: ${block.width||90}%</label><input type="range" min="10" max="100" value="${block.width||90}" oninput="updateBlock(${index}, 'width', this.value)"></div><div class="col"><label>Grosor: ${block.thickness||2}px</label><input type="range" min="1" max="10" value="${block.thickness||2}" oninput="updateBlock(${index}, 'thickness', this.value)"></div></div>`; }
                else if (block.type === 'button') { html += `<label>Texto</label><input type="text" value="${block.text||''}" oninput="updateBlock(${index},'text',this.value)"> <label>URL</label><input type="text" value="${block.link||''}" oninput="updateBlock(${index},'link',this.value)"> <label>Color</label><input type="color" value="${block.btnColor||'#1b396a'}" oninput="updateBlock(${index},'btnColor',this.value)">`; }
                html += `</div>`; container.innerHTML += html;
            });
        }

        function renderPreview() {
            // FIX CRITICO: Usar querySelectorAll para actualizar las barras por CLASE, no por ID
            const color = document.getElementById('accentColor').value;
            document.querySelectorAll('.preview-accent-line').forEach(el => el.style.backgroundColor = color);

            const tbody = document.getElementById('preview-content'); tbody.innerHTML = '';
            blocks.forEach(block => {
                let tr = document.createElement('tr'); let td = document.createElement('td'); td.style.fontFamily = 'Arial, sans-serif'; td.style.color = '#333';
                if (block.type === 'box') { td.style.padding = '15px 30px'; td.innerHTML = `<table width="100%" cellpadding="0" cellspacing="0" style="background-color:${block.bgColor}; border-radius:6px;"><tr><td style="padding:20px; color:${block.textColor}; font-size:15px; text-align:${block.align||'center'};">${block.content}</td></tr></table>`; }
                else if (block.type === 'text') { td.style.padding = '10px 30px'; td.style.fontSize = '16px'; td.style.lineHeight = '1.6'; td.style.textAlign = block.align||'left'; td.innerHTML = block.content; }
                
                else if (block.type === 'header_tri') {
                    td.style.padding = '10px 20px';
                    td.innerHTML = `
                        <table width="100%" border="0" cellspacing="0" cellpadding="0">
                            <tr>
                                <td width="20%" align="left" valign="middle"><img src="${fixGithubUrl(block.logo1)}" style="width:${block.logoWidth||60}%; max-width:100px; height:auto; display:block;"></td>
                                <td width="60%" align="center" valign="middle" style="padding:0 10px;"><div style="color:#1b396a; font-weight:bold; font-size:14px; line-height:1.2; margin-bottom:4px; text-transform:uppercase;">${block.line1}</div><div style="color:#555; font-size:13px; line-height:1.2;">${block.line2}</div></td>
                                <td width="20%" align="right" valign="middle"><img src="${fixGithubUrl(block.logo2)}" style="width:${block.logoWidth||60}%; max-width:100px; height:auto; display:block;"></td>
                            </tr>
                        </table>`;
                }

                else if (block.type === 'columns') { td.style.padding = '10px 20px'; let col1Html = block.col1Type === 'image' ? `<img src="${fixGithubUrl(block.col1Content)}" style="width:${block.col1Width||100}%; max-width:100%; height:auto; display:inline-block;">` : block.col1Content.replace(/\n/g, '<br>'); let col2Html = block.col2Type === 'image' ? `<img src="${fixGithubUrl(block.col2Content)}" style="width:${block.col2Width||100}%; max-width:100%; height:auto; display:inline-block;">` : block.col2Content.replace(/\n/g, '<br>'); td.innerHTML = `<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td width="50%" valign="middle" align="${block.col1Align||'left'}" style="padding-right:10px;">${col1Html}</td><td width="50%" valign="middle" align="${block.col2Align||'left'}" style="padding-left:10px;">${col2Html}</td></tr></table>`; }
                else if (block.type === 'image') { td.style.padding = '10px 30px'; td.align = block.align||'center'; if(block.url) td.innerHTML = `<img src="${fixGithubUrl(block.url)}" style="width: ${block.width||100}%; max-width: 100%; height: auto; display: inline-block;">`; }
                else if (block.type === 'html') { td.innerHTML = block.content; }
                else if (block.type === 'separator') { td.align = 'center'; td.innerHTML = `<hr style="width:${block.width||90}%; border:0; border-top:${block.thickness||2}px ${block.style||'solid'} ${block.color}; margin:15px auto;">`; }
                else if (block.type === 'button') { td.align = 'center'; td.style.padding = '20px'; td.innerHTML = `<a href="${block.link}" style="background:${block.btnColor}; color:white; padding:12px 24px; text-decoration:none; border-radius:4px; font-weight:bold; display:inline-block;">${block.text}</a>`; }
                tr.appendChild(td); tbody.appendChild(tr);
            });
        }
        async function copyToClipboard() { const t=document.getElementById('copy-target'),r=document.createRange(),s=window.getSelection();r.selectNode(t);s.removeAllRanges();s.addRange(r);try{document.execCommand('copy');document.getElementById('msg').style.display='block';setTimeout(()=>document.getElementById('msg').style.display='none',3000);}catch(e){}s.removeAllRanges(); }

        renderControls(); renderPreview();
    </script>
</body>
</html>